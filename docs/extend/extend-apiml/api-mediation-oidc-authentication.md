# Zowe API Mediation Layer OIDC authentication

Zowe API ML can be configured to authenticate users by accepting Access Tokens issued by an external Identity Provider (IDP) implementing OIDC/OAuth protocols.

This article provides details of the OIDC authentication functionality and related configuration needed to achieve it.

- [OIDC Usage](#oidc-usage)
- [Authentication Workflow](#authentication-flow)
- [Configuration](#oidc-configuration)
    * [Prerequisites](#prerequisites)
    * [OIDC provider configuration](#oidc-provider-configuration)
    * [API ML GW configuration](#api-ml-gw-configuration)
- [Technical details](#technical-details)
- [Troubleshooting](#troubleshooting)

## OIDC Usage
[OIDC](https://openid.net/specs/openid-connect-core-1_0.html) protocol adds an authentication layer on top of the [OAuth2](https://www.rfc-editor.org/rfc/rfc6749) Authorization protocol. 
It is used to request a trusted distributed OIDC provider to authenticate the user and after successful login to grant the client application an Access Token (along with Identity Token, eventually Refresh Token if requested).
The JWT Access Token obtained from the trusted OIDC/IDP can be used to authenticate the user (and authorize the client) to access mainframe resources through the API ML GW.

**Note:** Currently, API ML can provide SSO only in a single security domain.

## Authentication Flow
The following diagram describes the interactions between the general participants in the OIDC authentication process with API ML GW.

<img src={require("../../images/api-mediation/apiml-oidc-auth-seq.png").default} alt="APIML OIDC Workflow" width="700"/>

When the User wants to access mainframe resources or services using the Client application without a valid authentication / access token, 
the Client redirects the User agent to the login page of the distributed OIDC provider. The user is asked to provide valid credentials in form of authentication factors.
After successful validation of all authentication factors, the OIDC provider would grant the Client an access token. 
The client then requests from API ML GW the needed mainframe resources presenting the access token in the request.
The GW validates the distributed access token at the OIDC provider's /inttrospection end-point and caches for short time the outcome of a successful validation.
In subsequent calls with the same token, the GW will reuse the validation outcome. This is needed to save round trips to the OIDC /introspection endpoint 
for a short interval when the client would be accessing multiple resources in a sequence to complete a unit of work. The caching interval is configurable with a sensible default. 
In case that the distribted access token is valid, the gateway fetches the user identity from the token and maps it to the user mainfrae identity using a SAF call.
The mainframe user identity is then used to create the mainframe user credentials (Zowe or SAF JWT or pass-ticket) expected by the mainframe service which provides the requested resource.

## OIDC Configuration

### Prerequisites

- The users who need access to mainframe resources using OIDC authentication must have a mainframe identity managed by SAF/ESM
- The users need to have distributed identity managed by the OIDC provider  
- SAF/ESM is configured with mapping between the mainframe and distributed user identities
  
### OIDC provider configuration

- Client Application configuration in the OIDC provider. 

  Depending on the OIDC provider and client application capabilities the configuration of the OIDC provider would vary.
For example Web Applications with a secure server side component can use `code grant authorization flow` and can be granted Refresh Token, whereas a Single Page Application running entirely in the User Agent (browser) is more limited regarding its security capabilities.  

  Consult your OIDC provider documentation for options and requirements available for your type of client application. 

- Users assignment to the Client Application.

  Users who will be allowed to access the mainframe resources with a distributed authentication must be eiter directly assigned by the OIDC provider to the client application,
or must be part of group which is allowed to work with the client application.     

### API ML GW configuration
* Allow OIDC authentication in zowe.yaml
  * set oidc_allowed

* OIDC configuration in the API ML GW application.yaml - Provide the values for the following configuration parameters in the API ML GW application.yaml, where:
  - clientId is the ID of the API ML GW client registeration in the OIDC provider
  - clientSecret is the secret generated by the OIDC provider
  - registry is the SAF/ESM registry used to group the user identities mapping from OIDC to SAF
```
  security:
      oidc:
          enabled: true
          clientId: ${apiml_gateway_oidc_client_id}
          clientSecret: ${apiml_gateway_oidc_client_secret}
          registry: ${saf_oidc_registry_name} 
```

* SAF/ESM configuration
  - sds
  - 

## Technical details

## Troubleshooting
